<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - El Parche del Gato</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="config.js"></script>
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --naranja: #ff9800;
      --naranja-oscuro: #ff6600;
      --amarillo: #ffcc00;
      --radius: 16px;
      --radius-sm: 10px;

      /* Tema claro (default) */
      --bg-body: #f0f0f0;
      --bg-card: #ffffff;
      --bg-card-alt: rgba(255,255,255,0.95);
      --bg-header: #ffffff;
      --bg-filtros: #ffffff;
      --bg-table-head: rgba(255,150,0,0.08);
      --bg-dist-track: rgba(0,0,0,0.07);
      --bg-periodo: #f5f5f5;
      --color-texto: #222;
      --gris-texto: #666;
      --border-color: rgba(0,0,0,0.08);
      --border-btn: rgba(255,150,0,0.5);
      --separador: rgba(0,0,0,0.07);
      --bg-loading: rgba(255,255,255,0.7);
      --shadow: 0 2px 12px rgba(0,0,0,0.07);
    }

    body.tema-oscuro {
      --bg-body: #18191e;
      --bg-card: #23252c;
      --bg-card-alt: #23252c;
      --bg-header: #23252c;
      --bg-filtros: #23252c;
      --bg-table-head: rgba(255,150,0,0.1);
      --bg-dist-track: rgba(255,255,255,0.07);
      --bg-periodo: #2c2e35;
      --color-texto: #f0f0f0;
      --gris-texto: #aaa;
      --border-color: rgba(255,255,255,0.07);
      --border-btn: rgba(255,150,0,0.4);
      --separador: rgba(255,255,255,0.07);
      --bg-loading: rgba(0,0,0,0.6);
      --shadow: 0 2px 16px rgba(0,0,0,0.4);
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: var(--bg-body);
      min-height: 100vh;
      color: var(--color-texto);
      transition: background 0.3s, color 0.3s;
    }

    /* Toggle tema */
    #btn-tema {
      background: var(--bg-periodo);
      border: 1.5px solid var(--border-btn);
      color: var(--gris-texto);
      border-radius: 50px;
      padding: 6px 14px;
      font-size: 0.78rem;
      font-family: 'Poppins', sans-serif;
      cursor: pointer;
      margin-top: 4px;
      transition: all 0.2s;
    }
    #btn-tema:hover { border-color: var(--naranja-oscuro); color: var(--naranja-oscuro); }

    /* ---- PIN SCREEN ---- */
    #pin-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      gap: 20px;
      padding: 20px;
    }

    #pin-screen .pin-card {
      background: var(--bg-card);
      border-radius: var(--radius);
      padding: 40px 32px;
      text-align: center;
      max-width: 360px;
      width: 100%;
      box-shadow: 0 8px 32px rgba(0,0,0,0.15);
    }

    #pin-screen img.logo {
      width: 80px;
      margin-bottom: 12px;
    }

    #pin-screen h2 {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--naranja-oscuro);
      margin-bottom: 4px;
    }

    #pin-screen p {
      font-size: 0.82rem;
      color: var(--gris-texto);
      margin-bottom: 24px;
    }

    #pin-input {
      width: 100%;
      padding: 14px;
      font-size: 1.4rem;
      text-align: center;
      letter-spacing: 8px;
      border: 2px solid rgba(255,150,0,0.4);
      border-radius: var(--radius-sm);
      font-family: 'Poppins', sans-serif;
      margin-bottom: 12px;
      outline: none;
    }

    #pin-input:focus { border-color: var(--naranja-oscuro); }

    #pin-error {
      color: #e53935;
      font-size: 0.8rem;
      margin-bottom: 8px;
      min-height: 18px;
    }

    .btn {
      background: linear-gradient(135deg, var(--naranja-oscuro), var(--naranja));
      color: white;
      border: none;
      border-radius: 50px;
      padding: 12px 32px;
      font-size: 1rem;
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      transition: opacity 0.2s;
    }

    .btn:hover { opacity: 0.88; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    /* ---- DASHBOARD ---- */
    #dashboard-screen {
      display: none;
      max-width: 1100px;
      margin: 0 auto;
      padding: 20px 16px 40px;
    }

    /* Header */
    .dash-header {
      display: flex;
      align-items: center;
      gap: 14px;
      background: var(--bg-header);
      border-radius: var(--radius);
      padding: 14px 20px;
      margin-bottom: 18px;
      box-shadow: var(--shadow);
    }

    .dash-header img { width: 52px; height: 52px; object-fit: contain; }

    .dash-header-text h1 {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--naranja-oscuro);
    }

    .dash-header-text p {
      font-size: 0.75rem;
      color: var(--gris-texto);
    }

    .dash-header-right {
      margin-left: auto;
      font-size: 0.72rem;
      color: var(--gris-texto);
      text-align: right;
    }

    #ultima-actualizacion { font-size: 0.7rem; color: var(--gris-texto); }

    #refresh-countdown {
      font-size: 0.68rem;
      color: var(--gris-texto);
      margin-top: 1px;
    }
    #refresh-countdown strong { color: var(--naranja-oscuro); }

    #btn-salir {
      background: transparent;
      border: 1.5px solid var(--naranja-oscuro);
      color: var(--naranja-oscuro);
      border-radius: 50px;
      padding: 6px 16px;
      font-size: 0.78rem;
      font-family: 'Poppins', sans-serif;
      cursor: pointer;
      margin-top: 4px;
    }

    /* Filtros */
    .filtros {
      background: var(--bg-filtros);
      border-radius: var(--radius);
      padding: 14px 20px;
      margin-bottom: 18px;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }

    .filtros label {
      font-size: 0.78rem;
      font-weight: 600;
      color: var(--naranja-oscuro);
    }

    .filtros select, .filtros input[type="date"] {
      padding: 7px 12px;
      border: 1.5px solid var(--border-btn);
      border-radius: 50px;
      font-family: 'Poppins', sans-serif;
      font-size: 0.82rem;
      outline: none;
      background: var(--bg-card);
      color: var(--color-texto);
    }

    .filtros select:focus, .filtros input[type="date"]:focus {
      border-color: var(--naranja-oscuro);
    }

    .periodo-btns {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .periodo-btn {
      padding: 6px 14px;
      border-radius: 50px;
      border: 1.5px solid var(--border-btn);
      background: var(--bg-periodo);
      color: var(--color-texto);
      font-family: 'Poppins', sans-serif;
      font-size: 0.78rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .periodo-btn.active {
      background: var(--naranja-oscuro);
      color: white;
      border-color: var(--naranja-oscuro);
    }

    .custom-dates {
      display: none;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .custom-dates.visible { display: flex; }

    /* Cards resumen */
    .cards-resumen {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 18px;
    }

    .card {
      background: var(--bg-card);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      padding: 18px 16px;
      text-align: center;
    }

    .card .card-label {
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--gris-texto);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
    }

    .card .card-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--naranja-oscuro);
      line-height: 1;
    }

    .card .card-sub {
      font-size: 0.7rem;
      color: var(--gris-texto);
      margin-top: 4px;
    }

    /* Loading */
    #loading-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: var(--bg-loading);
      backdrop-filter: blur(4px);
      z-index: 100;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      font-weight: 600;
      color: var(--naranja-oscuro);
    }

    /* Secci√≥n */
    .seccion {
      background: var(--bg-card);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 18px;
    }

    .seccion h2 {
      font-size: 0.9rem;
      font-weight: 700;
      color: var(--naranja-oscuro);
      margin-bottom: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Encabezado de secci√≥n con control adicional */
    .seccion-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 14px;
      flex-wrap: wrap;
      gap: 8px;
    }

    .seccion-header h2 { margin-bottom: 0; }

    .umbral-control {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.78rem;
      color: var(--gris-texto);
    }

    .umbral-control select {
      padding: 5px 10px;
      border: 1.5px solid var(--border-btn);
      border-radius: 50px;
      font-family: 'Poppins', sans-serif;
      font-size: 0.78rem;
      background: var(--bg-card);
      color: var(--color-texto);
      outline: none;
      cursor: pointer;
    }

    /* Tabla sedes */
    .tabla-sedes {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    .tabla-sedes th {
      text-align: left;
      padding: 8px 12px;
      background: var(--bg-table-head);
      color: var(--naranja-oscuro);
      font-weight: 700;
      font-size: 0.75rem;
      text-transform: uppercase;
    }

    .tabla-sedes td {
      padding: 10px 12px;
      border-bottom: 1px solid var(--separador);
      color: var(--color-texto);
    }

    .tabla-sedes tr:last-child td { border-bottom: none; }
    .tabla-sedes .sede-nombre { font-weight: 600; }

    .score {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-weight: 700;
    }

    .score-bar {
      display: inline-block;
      height: 6px;
      border-radius: 3px;
      background: linear-gradient(90deg, var(--naranja-oscuro), var(--amarillo));
    }

    /* Tabla mesas */
    .tabla-mesas {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.83rem;
    }

    .tabla-mesas th {
      text-align: left;
      padding: 8px 10px;
      background: var(--bg-table-head);
      color: var(--naranja-oscuro);
      font-weight: 700;
      font-size: 0.72rem;
      text-transform: uppercase;
    }

    .tabla-mesas td {
      padding: 9px 10px;
      border-bottom: 1px solid var(--separador);
      color: var(--color-texto);
    }

    .tabla-mesas tr:last-child td { border-bottom: none; }

    .td-bajo {
      color: #e53935;
      font-weight: 700;
      background: rgba(229,57,53,0.06);
    }

    .td-ok { color: var(--gris-texto); }

    /* Gr√°fico tendencia */
    .chart-container {
      position: relative;
      height: 260px;
    }

    /* Distribuci√≥n */
    .dist-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .dist-categoria h3 {
      font-size: 0.78rem;
      font-weight: 600;
      color: var(--naranja-oscuro);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 10px;
    }

    .dist-barra {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
      font-size: 0.75rem;
    }

    .dist-label { width: 30px; text-align: right; font-weight: 600; color: var(--gris-texto); }

    .dist-track {
      flex: 1;
      height: 16px;
      background: var(--bg-dist-track);
      border-radius: 8px;
      overflow: hidden;
    }

    .dist-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--naranja-oscuro), var(--naranja));
      border-radius: 8px;
      transition: width 0.5s ease;
    }

    .dist-count { width: 28px; color: var(--gris-texto); font-size: 0.72rem; }

    /* Comentarios */
    .comentario-item {
      border-bottom: 1px solid var(--separador);
      padding: 12px 0;
    }

    .comentario-item:last-child { border-bottom: none; }

    .comentario-meta {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 4px;
      flex-wrap: wrap;
    }

    .comentario-sede {
      font-size: 0.72rem;
      font-weight: 700;
      color: var(--naranja-oscuro);
      background: rgba(255,150,0,0.12);
      padding: 2px 10px;
      border-radius: 50px;
    }

    .comentario-fecha {
      font-size: 0.7rem;
      color: var(--gris-texto);
    }

    .comentario-mesa {
      font-size: 0.7rem;
      color: var(--gris-texto);
    }

    .comentario-texto {
      font-size: 0.85rem;
      color: var(--color-texto);
      font-style: italic;
    }

    .no-data {
      text-align: center;
      color: var(--gris-texto);
      font-size: 0.85rem;
      padding: 20px 0;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .cards-resumen { grid-template-columns: repeat(2, 1fr); }
      .dist-grid { grid-template-columns: 1fr; }
      .filtros { flex-direction: column; align-items: flex-start; }

      .tabla-sedes th:nth-child(n+3),
      .tabla-sedes td:nth-child(n+3) { display: none; }

      .tabla-mesas th:nth-child(n+4),
      .tabla-mesas td:nth-child(n+4) { display: none; }
    }

    @media (max-width: 480px) {
      .cards-resumen { grid-template-columns: repeat(2, 1fr); }
      .card .card-value { font-size: 1.5rem; }
    }
  </style>
</head>
<body>

<!-- PIN SCREEN -->
<div id="pin-screen">
  <div class="pin-card">
    <img src="assets/logo.png" alt="Logo" class="logo" onerror="this.style.display='none'" />
    <h2>El Parche del Gato</h2>
    <p>Dashboard de m√©tricas ‚Äî acceso restringido</p>
    <input type="password" id="pin-input" maxlength="4" placeholder="¬∑ ¬∑ ¬∑ ¬∑" inputmode="numeric" />
    <div id="pin-error"></div>
    <button class="btn" id="btn-ingresar">Ingresar</button>
  </div>
</div>

<!-- LOADING OVERLAY -->
<div id="loading-overlay">Cargando datos...</div>

<!-- DASHBOARD SCREEN -->
<div id="dashboard-screen">

  <!-- Header -->
  <div class="dash-header">
    <img src="assets/logo.png" alt="Logo" onerror="this.style.display='none'" />
    <div class="dash-header-text">
      <h1>El Parche del Gato</h1>
      <p>Dashboard de calificaciones</p>
    </div>
    <div class="dash-header-right">
      <div id="ultima-actualizacion"></div>
      <div id="refresh-countdown"></div>
      <div style="display:flex;gap:6px;margin-top:4px;justify-content:flex-end">
        <button id="btn-tema">‚òÄÔ∏è Claro</button>
        <button id="btn-salir">Cerrar sesi√≥n</button>
      </div>
    </div>
  </div>

  <!-- Filtros -->
  <div class="filtros">
    <div>
      <label for="filtro-sede">Sede</label><br/>
      <select id="filtro-sede">
        <option value="ALL">Todas las sedes</option>
      </select>
    </div>
    <div>
      <label>Per√≠odo</label><br/>
      <div class="periodo-btns">
        <button class="periodo-btn" data-periodo="hoy">Hoy</button>
        <button class="periodo-btn" data-periodo="ayer">Ayer</button>
        <button class="periodo-btn" data-periodo="7">7 d√≠as</button>
        <button class="periodo-btn active" data-periodo="30">30 d√≠as</button>
        <button class="periodo-btn" data-periodo="mes">Este mes</button>
        <button class="periodo-btn" data-periodo="custom">Personalizado</button>
      </div>
    </div>
    <div class="custom-dates" id="custom-dates">
      <input type="date" id="fecha-inicio" />
      <span style="color:#666">‚Äî</span>
      <input type="date" id="fecha-fin" />
      <button class="periodo-btn active" id="btn-aplicar-fechas">Aplicar</button>
    </div>
  </div>

  <!-- Cards resumen -->
  <div class="cards-resumen">
    <div class="card">
      <div class="card-label">Total respuestas</div>
      <div class="card-value" id="card-total">‚Äî</div>
      <div class="card-sub">en el per√≠odo</div>
    </div>
    <div class="card">
      <div class="card-label">Promedio general</div>
      <div class="card-value" id="card-general">‚Äî</div>
      <div class="card-sub">satisfacci√≥n</div>
    </div>
    <div class="card">
      <div class="card-label">Mejor categor√≠a</div>
      <div class="card-value" id="card-mejor" style="font-size:1.1rem">‚Äî</div>
      <div class="card-sub" id="card-mejor-val"></div>
    </div>
    <div class="card">
      <div class="card-label">A mejorar</div>
      <div class="card-value" id="card-peor" style="font-size:1.1rem">‚Äî</div>
      <div class="card-sub" id="card-peor-val"></div>
    </div>
  </div>

  <!-- Por sede -->
  <div class="seccion" id="seccion-sedes">
    <h2>Comparativo por sede</h2>
    <div id="tabla-sedes-container"></div>
  </div>

  <!-- Mesas con alertas -->
  <div class="seccion" id="seccion-mesas">
    <div class="seccion-header">
      <h2>‚ö†Ô∏è Mesas con alertas</h2>
      <div class="umbral-control">
        <label for="sel-umbral">Umbral:</label>
        <select id="sel-umbral">
          <option value="20">20% (solo 1‚òÖ)</option>
          <option value="40" selected>40% (‚â§ 2‚òÖ)</option>
          <option value="60">60% (‚â§ 3‚òÖ)</option>
        </select>
      </div>
    </div>
    <div id="tabla-mesas-container"></div>
  </div>

  <!-- Tendencia -->
  <div class="seccion">
    <h2>Tendencia en el tiempo</h2>
    <div class="chart-container">
      <canvas id="chart-tendencia"></canvas>
    </div>
  </div>

  <!-- Distribuci√≥n -->
  <div class="seccion">
    <h2>Distribuci√≥n de calificaciones</h2>
    <div class="dist-grid" id="dist-grid"></div>
  </div>

  <!-- Comentarios -->
  <div class="seccion">
    <h2>Comentarios recientes</h2>
    <div id="comentarios-lista"></div>
  </div>

</div>

<script>
(function() {
  'use strict';

  var API_URL = CONFIG.API_URL;
  var ADMIN_PIN = CONFIG.ADMIN_PIN;
  var SESSION_KEY = 'pdg_dash_auth';
  var TEMA_KEY = 'pdg_dash_tema';
  var UMBRAL_KEY = 'pdg_dash_umbral';
  var REFRESH_INTERVAL = 5 * 60; // segundos

  var state = {
    sede: 'ALL',
    fechaInicio: null,
    fechaFin: null,
    periodo: '30',
    umbral: 40,
    porMesaDatos: [],
    chartTendencia: null
  };

  var countdownTimer = null;
  var refreshSecondsLeft = REFRESH_INTERVAL;

  // ---- HELPERS DE PORCENTAJE ----
  function toPct(val) { return Math.round(val * 20); }
  function fmtPct(val) { return toPct(val) + '%'; }

  // ---- JSONP ----
  function fetchWithCallback(url, timeoutMs) {
    return new Promise(function(resolve, reject) {
      var cbName = 'dash_cb_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
      var timer = setTimeout(function() {
        cleanup();
        reject(new Error('Timeout'));
      }, timeoutMs || 15000);

      function cleanup() {
        clearTimeout(timer);
        delete window[cbName];
        if (script.parentNode) script.parentNode.removeChild(script);
      }

      window[cbName] = function(data) {
        cleanup();
        resolve(data);
      };

      var script = document.createElement('script');
      script.src = url + (url.indexOf('?') >= 0 ? '&' : '?') + 'callback=' + cbName;
      script.onerror = function() {
        cleanup();
        reject(new Error('Error de conexi√≥n'));
      };
      document.head.appendChild(script);
    });
  }

  function apiCall(url) {
    return fetchWithCallback(url, 15000).catch(function() {
      return fetch(url, { credentials: 'omit', redirect: 'follow' }).then(function(r) { return r.json(); });
    });
  }

  // ---- TEMA ----
  function aplicarTema(tema) {
    if (tema === 'oscuro') {
      document.body.classList.add('tema-oscuro');
      document.getElementById('btn-tema').textContent = 'üåô Oscuro';
    } else {
      document.body.classList.remove('tema-oscuro');
      document.getElementById('btn-tema').textContent = '‚òÄÔ∏è Claro';
    }
    localStorage.setItem(TEMA_KEY, tema);
  }

  document.getElementById('btn-tema').addEventListener('click', function() {
    var actual = localStorage.getItem(TEMA_KEY) || 'claro';
    aplicarTema(actual === 'claro' ? 'oscuro' : 'claro');
  });

  aplicarTema(localStorage.getItem(TEMA_KEY) || 'claro');

  // ---- AUTO-REFRESH ----
  function iniciarAutoRefresh() {
    clearInterval(countdownTimer);
    refreshSecondsLeft = REFRESH_INTERVAL;
    actualizarContador();

    countdownTimer = setInterval(function() {
      refreshSecondsLeft--;
      actualizarContador();
      if (refreshSecondsLeft <= 0) {
        refreshSecondsLeft = REFRESH_INTERVAL;
        cargarDashboard();
      }
    }, 1000);
  }

  function actualizarContador() {
    var m = Math.floor(refreshSecondsLeft / 60);
    var s = refreshSecondsLeft % 60;
    var el = document.getElementById('refresh-countdown');
    if (el) el.innerHTML = 'Actualizaci√≥n en <strong>' + m + ':' + (s < 10 ? '0' : '') + s + '</strong>';
  }

  // ---- AUTENTICACI√ìN ----
  function checkAuth() {
    if (sessionStorage.getItem(SESSION_KEY) === 'ok') {
      showDashboard();
    }
  }

  document.getElementById('btn-ingresar').addEventListener('click', function() {
    var val = document.getElementById('pin-input').value;
    if (val === ADMIN_PIN) {
      sessionStorage.setItem(SESSION_KEY, 'ok');
      showDashboard();
    } else {
      document.getElementById('pin-error').textContent = 'PIN incorrecto';
      document.getElementById('pin-input').value = '';
    }
  });

  document.getElementById('pin-input').addEventListener('keydown', function(e) {
    document.getElementById('pin-error').textContent = '';
    if (e.key === 'Enter') document.getElementById('btn-ingresar').click();
  });

  document.getElementById('btn-salir').addEventListener('click', function() {
    clearInterval(countdownTimer);
    sessionStorage.removeItem(SESSION_KEY);
    document.getElementById('pin-screen').style.display = 'flex';
    document.getElementById('dashboard-screen').style.display = 'none';
    document.getElementById('pin-input').value = '';
  });

  // ---- FILTROS ----
  document.getElementById('filtro-sede').addEventListener('change', function() {
    state.sede = this.value;
    cargarDashboard();
  });

  document.querySelectorAll('.periodo-btn[data-periodo]').forEach(function(btn) {
    btn.addEventListener('click', function() {
      document.querySelectorAll('.periodo-btn[data-periodo]').forEach(function(b) { b.classList.remove('active'); });
      btn.classList.add('active');
      state.periodo = btn.dataset.periodo;
      var customDates = document.getElementById('custom-dates');
      if (state.periodo === 'custom') {
        customDates.classList.add('visible');
      } else {
        customDates.classList.remove('visible');
        calcularFechas();
        cargarDashboard();
      }
    });
  });

  document.getElementById('btn-aplicar-fechas').addEventListener('click', function() {
    state.fechaInicio = document.getElementById('fecha-inicio').value;
    state.fechaFin = document.getElementById('fecha-fin').value;
    if (state.fechaInicio && state.fechaFin) cargarDashboard();
  });

  // ---- UMBRAL ----
  document.getElementById('sel-umbral').addEventListener('change', function() {
    state.umbral = +this.value;
    sessionStorage.setItem(UMBRAL_KEY, state.umbral);
    renderMesas(state.porMesaDatos, state.umbral);
  });

  function calcularFechas() {
    var hoy = new Date();
    var fin = formatDate(hoy);
    var inicio;

    switch (state.periodo) {
      case 'hoy':
        inicio = fin;
        break;
      case 'ayer':
        var ayer = new Date(hoy - 86400000);
        inicio = formatDate(ayer);
        fin = inicio;
        break;
      case '7':
        inicio = formatDate(new Date(hoy - 6 * 86400000));
        break;
      case '30':
        inicio = formatDate(new Date(hoy - 29 * 86400000));
        break;
      case 'mes':
        inicio = hoy.getFullYear() + '-' + String(hoy.getMonth() + 1).padStart(2, '0') + '-01';
        break;
      default:
        inicio = formatDate(new Date(hoy - 29 * 86400000));
    }

    state.fechaInicio = inicio;
    state.fechaFin = fin;
  }

  function formatDate(d) {
    return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
  }

  // ---- CARGA DE SEDES ----
  function cargarSedes() {
    apiCall(API_URL + '?action=getSedes').then(function(data) {
      if (data.success && data.sedes) {
        var sel = document.getElementById('filtro-sede');
        data.sedes.forEach(function(s) {
          var opt = document.createElement('option');
          opt.value = s.codigo_pv;
          opt.textContent = s.nombre_pv;
          sel.appendChild(opt);
        });
      }
    }).catch(function() {});
  }

  // ---- CARGA PRINCIPAL ----
  function cargarDashboard() {
    var overlay = document.getElementById('loading-overlay');
    overlay.style.display = 'flex';

    var url = API_URL + '?action=getDashboard'
      + '&codigo_pv=' + encodeURIComponent(state.sede)
      + '&fecha_inicio=' + encodeURIComponent(state.fechaInicio || '')
      + '&fecha_fin=' + encodeURIComponent(state.fechaFin || '');

    apiCall(url).then(function(data) {
      overlay.style.display = 'none';
      if (data.success) {
        state.porMesaDatos = data.por_mesa || [];
        renderResumen(data.resumen);
        renderSedes(data.por_sede);
        renderMesas(state.porMesaDatos, state.umbral);
        renderTendencia(data.tendencia);
        renderDistribucion(data.distribucion, data.resumen.total);
        renderComentarios(data.comentarios);
        document.getElementById('ultima-actualizacion').textContent =
          'Actualizado: ' + new Date().toLocaleTimeString('es-CO', { hour: '2-digit', minute: '2-digit' });
        iniciarAutoRefresh();
      }
    }).catch(function(err) {
      overlay.style.display = 'none';
      alert('Error al cargar datos: ' + err.message);
    });
  }

  // ---- RENDER RESUMEN ----
  var CATEGORIAS = { servicio: 'Servicio', comida: 'Comida', infraestructura: 'Infraestructura', musica: 'M√∫sica' };

  function renderResumen(r) {
    document.getElementById('card-total').textContent = r.total;
    document.getElementById('card-general').textContent = r.total > 0 ? fmtPct(r.general) : '‚Äî';

    if (r.total > 0) {
      var cats = ['servicio', 'comida', 'infraestructura', 'musica'];
      var vals = cats.map(function(c) { return r[c]; });
      var maxIdx = vals.indexOf(Math.max.apply(null, vals));
      var minIdx = vals.indexOf(Math.min.apply(null, vals));

      document.getElementById('card-mejor').textContent = CATEGORIAS[cats[maxIdx]];
      document.getElementById('card-mejor-val').textContent = fmtPct(vals[maxIdx]);
      document.getElementById('card-peor').textContent = CATEGORIAS[cats[minIdx]];
      document.getElementById('card-peor-val').textContent = fmtPct(vals[minIdx]);
    } else {
      ['card-mejor', 'card-peor'].forEach(function(id) { document.getElementById(id).textContent = '‚Äî'; });
      ['card-mejor-val', 'card-peor-val'].forEach(function(id) { document.getElementById(id).textContent = ''; });
    }
  }

  // ---- RENDER SEDES ----
  function renderSedes(sedes) {
    var container = document.getElementById('tabla-sedes-container');
    if (!sedes || sedes.length === 0) {
      container.innerHTML = '<p class="no-data">Sin datos en el per√≠odo seleccionado</p>';
      return;
    }

    var html = '<table class="tabla-sedes"><thead><tr>'
      + '<th>Sede</th><th>Respuestas</th><th>Servicio</th><th>Comida</th><th>Infraestructura</th><th>M√∫sica</th><th>Promedio</th>'
      + '</tr></thead><tbody>';

    sedes.forEach(function(s) {
      var prom = Math.round((s.servicio + s.comida + s.infraestructura + s.musica) / 4 * 20) + '%';
      html += '<tr>'
        + '<td class="sede-nombre">' + s.nombre_pv + '</td>'
        + '<td>' + s.total + '</td>'
        + '<td>' + scoreHtml(s.servicio) + '</td>'
        + '<td>' + scoreHtml(s.comida) + '</td>'
        + '<td>' + scoreHtml(s.infraestructura) + '</td>'
        + '<td>' + scoreHtml(s.musica) + '</td>'
        + '<td><strong>' + prom + '</strong></td>'
        + '</tr>';
    });

    html += '</tbody></table>';
    container.innerHTML = html;
  }

  function scoreHtml(val) {
    var w = Math.round((val / 5) * 60);
    return '<span class="score">' + fmtPct(val)
      + ' <span class="score-bar" style="width:' + w + 'px"></span></span>';
  }

  // ---- RENDER MESAS ----
  function renderMesas(porMesa, umbral) {
    var container = document.getElementById('tabla-mesas-container');
    if (!porMesa || porMesa.length === 0) {
      container.innerHTML = '<p class="no-data">Sin datos de mesa en el per√≠odo seleccionado</p>';
      return;
    }

    var maxRating = Math.floor(umbral / 20); // cu√°ntos niveles de rating contar como "bajos"

    var datos = porMesa.map(function(m) {
      var cats = ['servicio', 'comida', 'infraestructura', 'musica'];
      var bajosXCat = {};
      cats.forEach(function(cat) {
        var arr = m[cat] || [0, 0, 0, 0, 0];
        var count = 0;
        for (var i = 0; i < maxRating; i++) count += (arr[i] || 0);
        bajosXCat[cat] = count;
      });
      var totalBajos = bajosXCat.servicio + bajosXCat.comida + bajosXCat.infraestructura + bajosXCat.musica;
      return { mesa: m.mesa, total: m.total, bajosXCat: bajosXCat, totalBajos: totalBajos };
    }).filter(function(m) { return m.totalBajos > 0; })
      .sort(function(a, b) { return b.totalBajos - a.totalBajos; });

    if (datos.length === 0) {
      container.innerHTML = '<p class="no-data">‚úÖ Ninguna mesa con calificaciones bajo el umbral en el per√≠odo</p>';
      return;
    }

    var html = '<table class="tabla-mesas"><thead><tr>'
      + '<th>Mesa</th><th>Respuestas</th><th>Servicio</th><th>Comida</th><th>Infraest.</th><th>M√∫sica</th><th>Total bajos</th>'
      + '</tr></thead><tbody>';

    datos.forEach(function(m) {
      html += '<tr>'
        + '<td><strong>' + escHtml(m.mesa) + '</strong></td>'
        + '<td>' + m.total + '</td>'
        + tdBajo(m.bajosXCat.servicio)
        + tdBajo(m.bajosXCat.comida)
        + tdBajo(m.bajosXCat.infraestructura)
        + tdBajo(m.bajosXCat.musica)
        + '<td class="td-bajo">‚ö†Ô∏è ' + m.totalBajos + '</td>'
        + '</tr>';
    });

    html += '</tbody></table>';
    container.innerHTML = html;
  }

  function tdBajo(count) {
    if (count > 0) return '<td class="td-bajo">' + count + '</td>';
    return '<td class="td-ok">‚Äî</td>';
  }

  // ---- RENDER TENDENCIA ----
  function renderTendencia(tendencia) {
    var ctx = document.getElementById('chart-tendencia').getContext('2d');

    if (state.chartTendencia) {
      state.chartTendencia.destroy();
      state.chartTendencia = null;
    }

    if (!tendencia || tendencia.length === 0) {
      ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
      ctx.font = '14px Poppins, sans-serif';
      ctx.fillStyle = '#999';
      ctx.textAlign = 'center';
      ctx.fillText('Sin datos en el per√≠odo seleccionado', ctx.canvas.width / 2, 80);
      return;
    }

    var labels = tendencia.map(function(t) { return t.fecha; });
    var colores = {
      servicio: 'rgba(255,102,0,1)',
      comida: 'rgba(255,180,0,1)',
      infraestructura: 'rgba(0,150,200,1)',
      musica: 'rgba(100,200,80,1)'
    };

    var datasets = ['servicio', 'comida', 'infraestructura', 'musica'].map(function(cat) {
      return {
        label: CATEGORIAS[cat],
        data: tendencia.map(function(t) { return toPct(t[cat]); }),
        borderColor: colores[cat],
        backgroundColor: colores[cat].replace('1)', '0.08)'),
        tension: 0.3,
        pointRadius: tendencia.length <= 10 ? 4 : 2,
        borderWidth: 2,
        fill: false
      };
    });

    state.chartTendencia = new Chart(ctx, {
      type: 'line',
      data: { labels: labels, datasets: datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            min: 0, max: 100,
            ticks: {
              stepSize: 20,
              font: { family: 'Poppins', size: 11 },
              callback: function(v) { return v + '%'; }
            },
            grid: { color: 'rgba(0,0,0,0.06)' }
          },
          x: {
            ticks: {
              font: { family: 'Poppins', size: 10 },
              maxRotation: 45,
              maxTicksLimit: 14
            },
            grid: { display: false }
          }
        },
        plugins: {
          legend: {
            labels: { font: { family: 'Poppins', size: 11 }, boxWidth: 14 }
          },
          tooltip: {
            callbacks: {
              label: function(ctx) { return ctx.dataset.label + ': ' + ctx.parsed.y + '%'; }
            }
          }
        }
      }
    });
  }

  // ---- RENDER DISTRIBUCI√ìN ----
  function renderDistribucion(dist, total) {
    var grid = document.getElementById('dist-grid');
    if (!dist || total === 0) {
      grid.innerHTML = '<p class="no-data">Sin datos en el per√≠odo seleccionado</p>';
      return;
    }

    var html = '';
    var emojis = ['üòæ', 'üòø', 'üò∫', 'üò∏', 'üòª'];
    var labels = ['1 ‚Äî 20%', '2 ‚Äî 40%', '3 ‚Äî 60%', '4 ‚Äî 80%', '5 ‚Äî 100%'];

    ['servicio', 'comida', 'infraestructura', 'musica'].forEach(function(cat) {
      var arr = dist[cat];
      var maxVal = Math.max.apply(null, arr) || 1;
      html += '<div class="dist-categoria"><h3>' + CATEGORIAS[cat] + '</h3>';
      arr.forEach(function(count, i) {
        var pct = Math.round((count / maxVal) * 100);
        html += '<div class="dist-barra">'
          + '<span class="dist-label">' + emojis[i] + '</span>'
          + '<div class="dist-track"><div class="dist-fill" style="width:' + pct + '%"></div></div>'
          + '<span class="dist-count">' + count + '</span>'
          + '</div>';
      });
      html += '</div>';
    });

    grid.innerHTML = html;
  }

  // ---- RENDER COMENTARIOS ----
  function renderComentarios(comentarios) {
    var lista = document.getElementById('comentarios-lista');
    if (!comentarios || comentarios.length === 0) {
      lista.innerHTML = '<p class="no-data">No hay comentarios en el per√≠odo seleccionado</p>';
      return;
    }

    var html = '';
    comentarios.forEach(function(c) {
      html += '<div class="comentario-item">'
        + '<div class="comentario-meta">'
        + '<span class="comentario-sede">' + escHtml(c.nombre_pv) + '</span>'
        + '<span class="comentario-fecha">' + c.timestamp + '</span>'
        + (c.mesa ? '<span class="comentario-mesa">Mesa ' + escHtml(c.mesa) + '</span>' : '')
        + '</div>'
        + '<div class="comentario-texto">"' + escHtml(c.comentario) + '"</div>'
        + '</div>';
    });
    lista.innerHTML = html;
  }

  function escHtml(str) {
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;');
  }

  // ---- INIT ----
  function showDashboard() {
    // Restaurar umbral guardado
    var savedUmbral = sessionStorage.getItem(UMBRAL_KEY);
    if (savedUmbral) {
      state.umbral = +savedUmbral;
      var selUmbral = document.getElementById('sel-umbral');
      if (selUmbral) selUmbral.value = savedUmbral;
    }

    document.getElementById('pin-screen').style.display = 'none';
    document.getElementById('dashboard-screen').style.display = 'block';
    cargarSedes();
    calcularFechas();
    cargarDashboard();
  }

  checkAuth();

})();
</script>
</body>
</html>
